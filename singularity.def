Bootstrap: docker
From: ubuntu:22.04

%help
    Minimal, HPC-friendly Apptainer image for Seurat + Mixscape + Shiny.
    Run (WSL/Linux):
      apptainer run --bind /mnt/c/Users/jcape/Downloads/Perturb_seq_app/CRISPR_APP:/mnt/app mix_APP.sif
    Then open http://localhost:3838

%environment
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    export DEBIAN_FRONTEND=noninteractive
    # Overridable at runtime:
    export APP_PATH=/mnt/app
    export PORT=3838

%post
    set -eux

    # ---- Base setup ----
    ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime
    apt-get update
    apt-get install -y --no-install-recommends tzdata
    dpkg-reconfigure -f noninteractive tzdata

    apt-get install -y --no-install-recommends \
        locales sudo ca-certificates wget curl git gnupg \
        build-essential pandoc fonts-dejavu-core \
        libssl-dev libcurl4-openssl-dev libxml2-dev libgit2-dev \
        libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev \
        libharfbuzz-dev libfribidi-dev \
        libblas-dev liblapack-dev libhdf5-dev libglpk-dev libzmq3-dev \
        libmariadb-dev

    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

    # ---- R setup (CRAN for jammy) ----
    mkdir -p /etc/apt/keyrings
    curl -fsSL https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc \
      | gpg --dearmor -o /etc/apt/keyrings/cran-archive-keyring.gpg

    echo "deb [signed-by=/etc/apt/keyrings/cran-archive-keyring.gpg] https://cloud.r-project.org/bin/linux/ubuntu jammy-cran40/" \
      > /etc/apt/sources.list.d/cran.list

    apt-get update
    apt-get install -y --no-install-recommends r-base r-base-dev

# --- R packages (robust; ensures presto is installed) ---
R -q -e 'options(Ncpus=max(1, parallel::detectCores()-1), timeout=600);
  repos <- "https://cloud.r-project.org";
  install.packages(c("remotes","BiocManager"), repos=repos);
  install.packages(c(
    "shiny","ggplot2","dplyr","patchwork","scales","reshape2","mixtools","presto",
    "plotly","DT","markdown","Matrix","Rcpp","RANN","cowplot","future","ape","digest",
    "sctransform","irlba","httr","rlang","reticulate","data.table","R.utils","gridExtra",
    "pbapply","RCurl","MASS","magrittr","lazyeval","stringr","tidyr","tibble","cli","jsonlite",
    "sp","zoo","fastmatch","matrixStats","SparseM","progressr","randomForest","caret","pROC",
    "RColorBrewer","pwr","enrichR","gprofiler2"
  ), repos=repos);
  BiocManager::install(c(
    "SingleCellExperiment","SummarizedExperiment","GenomicRanges","IRanges","S4Vectors",
    "GenomeInfoDb","BiocGenerics","BiocParallel","limma","edgeR","Matrix.utils","DelayedArray",
    "DelayedMatrixStats","batchelor","scuttle","scran"
  ), ask=FALSE, update=FALSE);
  install.packages("Seurat", repos=repos);
  remotes::install_github("satijalab/seurat-data", upgrade="never");
  remotes::install_github("satijalab/seurat-wrappers", upgrade="never");
  # Mixscape from GitHub (optional; do not hard-fail on GH flakiness)
  try(remotes::install_github("satijalab/mixscape", upgrade="never"), silent=TRUE);

  # ---------- ENSURE PRESTO IS PRESENT (CRAN first, then GH fallback) ----------
  if (!requireNamespace("presto", quietly=TRUE)) {
    message("presto not found after initial installs — trying CRAN again...");
    install.packages("presto", repos=repos);
  }
  if (!requireNamespace("presto", quietly=TRUE)) {
    message("presto still missing — trying GitHub fallback immunogenomics/presto");
    if (!requireNamespace("remotes", quietly=TRUE)) install.packages("remotes", repos=repos);
    try(remotes::install_github("immunogenomics/presto", upgrade="never"), silent=TRUE);
  }
  if (!requireNamespace("presto", quietly=TRUE)) {
    stop("FATAL: presto failed to install from CRAN and GitHub during image build.");
  }

  ip <- as.data.frame(installed.packages()[,c("Package","Version")]);
  cat("Installed presto version: ",
      ip[ip[["Package"]] == "presto","Version"], "\n");
'


    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    # Launch Shiny app from $APP_PATH (default /mnt/app). Works with app.R OR ui.R/server.R.
    if [ ! -d "$APP_PATH" ] && [ ! -f "$APP_PATH" ]; then
        echo "APP_PATH '$APP_PATH' not found."
        echo "Bind your app dir, e.g.:"
        echo "  apptainer run --bind /mnt/c/Users/jcape/Downloads/Perturb_seq_app/CRISPR_APP:/mnt/app mix_APP.sif"
        exit 1
    fi
    echo 'Starting Shiny app at '"$APP_PATH"' on port '"${PORT}"'...'
    exec R -e "shiny::runApp(Sys.getenv('APP_PATH','/mnt/app'), host='0.0.0.0', port=as.integer(Sys.getenv('PORT','3838')))"



